# GoTXT2GEO

一个高效、灵活的命令行工具，用于将特定格式的文本坐标文件（宗地、地块等）转换为多种标准的地理空间矢量数据格式。

`GoTXT2GEO` 旨在简化地理数据处理的初始步骤，通过自动化的命令行操作，将原始的坐标文本快速转换为可在 GIS 软件（如 QGIS, ArcGIS）中直接使用的格式。

## ✨ 功能特性

- **强大的格式转换**：底层利用 QGIS 引擎，支持导出为 `ESRI Shapefile`, `FlatGeobuf`, `GeoPackage`, `OpenFileGDB` 等多种主流矢量格式。
- **灵活的输入**：支持单个文件、多个文件或整个目录的批量处理，并可通过 `--depth` 控制递归深度。
- **智能坐标系处理**：自动解析文件中的 `2000国家大地坐标系` 定义，支持 3 度和 6 度分带，并能根据坐标值推断和验证带号。
- **两种导出模式**：
  - **分散模式**：每个输入文件生成一个独立的输出文件。
  - **合并模式** (`--merge`)：将所有输入文件的地块合并到一个输出文件中。
- **自定义命名规则**：通过 `--name` 标志和模板占位符（如 `{name}`, `{index}`, `{date}` 等）精确控制输出文件名。
- **处理历史与缓存**：通过在输出目录生成 `.processed` 记录，避免重复处理未修改的文件，支持增量更新。使用 `--force-refresh` 可强制刷新。
- **预览与覆盖**：
  - `--dry-run`：在不执行任何写入操作的情况下，预览将要生成的导出计划。
  - `--overwrite`：允许覆盖已存在的目标文件。
- **跨平台命令行**：基于 Go 和 Cobra 构建，提供清晰、一致的命令行体验。

## 依赖项

1. **Go**: `1.25` 或更高版本。
2. **QGIS**: 项目的核心转换功能依赖于一个 Python 脚本，该脚本需要一个包含 QGIS 库的 Python 环境。请确保你的系统中安装了 QGIS，并且其 Python 环境是可访问的。
3. **UPX** (可选): `build.ps1` 脚本使用 UPX 来压缩生成的可执行文件，以减小体积。如果不需要压缩，可以忽略此项。

## 🚀 安装与构建

你可以通过项目根目录下的 `build.ps1` 脚本来编译项目。

```powershell
# 确保你的 PowerShell 执行策略允许运行脚本
# Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass

# 运行构建脚本
.\build.ps1
```

此脚本会自动执行以下操作：

1. 使用 `go build` 编译 Go 代码。
2. 将版本号、Git Commit ID 和构建日期等信息注入到可执行文件中。
3. 在 `release/` 目录下生成 `TXT2GEO.exe`。
4. 如果 `release/` 目录下存在 `upx.exe`，则会用它来压缩可执行文件。

## 📖 使用说明

`GoTXT2GEO` 提供了两种使用方式：快速模式和 `export` 子命令。

### 快速模式

直接将一个或多个文本文件拖到 `TXT2GEO.exe` 图标上，或者在命令行中直接提供文件路径。程序将使用默认配置（输出为 FGB 格式到 `output` 目录）进行处理。

```shell
# 快速处理一个或多个文件
./TXT2GEO.exe D:\data\test1.txt D:\data\test2.txt
```

程序会显示扫描到的文件，并等待用户按 Enter 键确认执行。

### `export` 子命令

`export` 子命令提供了完整的参数控制，是推荐的高级用法。

```shell
./TXT2GEO.exe export [标志]
```

#### 主要标志

- `-i, --input`: **(必需)** 指定输入文件或目录，可多次使用。
- `-o, --output`: **(必需)** 指定输出目录。
- `--format`: 输出格式，支持 `SHP` | `FGB` | `GPKG` | `GDB` (默认: `FGB`)。
- `--merge`: 合并所有输入到一个输出文件中。
- `--name`: 自定义输出文件名模板。支持以下占位符：
  - `{name}`: 源文件名（分散模式）或 "merged_output"（合并模式）。
  - `{index[:width]}`: 文件序号，支持补零，如 `{index:03}`。
  - `{count}`: 处理的总文件数。
  - `{date[:layout]}`: 当前日期，支持 Go 时间格式，如 `{date:2006-01-02}`。
  - `{uuid}`: 随机 UUID。
  - `{rand[:len]}`: 随机字符串，可指定长度。
- `--depth`: 目录递归深度 (默认: `-1`，无限递归)。
- `--dry-run`: 仅预览导出计划，不实际执行。
- `--overwrite`: 允许覆盖已存在的文件。
- `--force-refresh`: 强制重新处理所有文件，忽略处理历史。
- `--log-level`: 设置日志级别 (`debug`, `info`, `warn`, `error`)。

#### 示例

1. **分散导出**：将 `data` 目录下的所有 `.txt` 文件导出为 Shapefile，输出文件名格式为 `源文件名_序号.shp`。

   ```shell
   ./TXT2GEO.exe export -i D:\data -o D:\output --format SHP --name "{name}_{index:03}"
   ```
2. **合并导出**：将 `a.txt` 和 `b.txt` 两个文件合并，并导出为一个 GeoPackage 文件，命名为 `merged_data_20251031.gpkg`。

   ```shell
   ./TXT2GEO.exe export -i a.txt -i b.txt -o D:\output --format GPKG --merge --name "merged_data_{date}"
   ```
3. **预览计划**：查看将要执行的操作，但不生成任何文件。

   ```shell
   ./TXT2GEO.exe export -i D:\data -o D:\output --dry-run
   ```

## 📄 输入文件格式

`GoTXT2GEO` 需要特定格式的 `.txt` 文件，文件必须为 `UTF-8` 编码，主要包含两个部分：`[属性描述]` 和 `[地块坐标]`。

### `[属性描述]`

键值对形式的元数据，定义了坐标系、单位等信息。

- `坐标系`: 必须为 `2000国家大地坐标系`。
- `几度分带`: `3` 或 `6`。
- `带号`: 对应的带号。
- `投影类型`: `高斯克吕格`。

### `[地块坐标]`

包含一个或多个地块的坐标数据。

- 每个地块以 `@` 结尾的行开始，该行定义了地块的属性，如：`界址点数,地块面积,,地块名称,图形属性,,,,@`。
- 随后的行是该地块的坐标点列表，格式为：`点号,圈号,Y坐标,X坐标`。
  - **圈号 (Ring ID)**: 用于标识同一个地块内的不同环（例如，用于表示内飞地）。

### 示例

```
[属性描述]
格式版本号=1.01版本
数据生产单位=勘测公司
数据生产日期=2022-06-24
坐标系=2000国家大地坐标系
几度分带=3
投影类型=高斯克吕格
计量单位=米
带号=38
精度=0.001
[地块坐标]
40,0.1082, ,测试项目,面,,null,,@
1,1,2877166.246,38388289.812
2,1,2877160.772,38388299.786
...
40,1,2877166.246,38388289.812
```

## 📝 许可证

本项目根据 `LICENSE` 文件中的条款授权。
